<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>處理中...</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 確保佔滿整個視窗高度 */
            width: 100vw; /* 確保佔滿整個視窗寬度 */
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #statusMessage {
            font-size: 1.1em;
            color: #555;
            margin-top: 20px; /* 給訊息一些空間 */
        }
        #statusMessage.error {
            color: red; /* 錯誤訊息顯示紅色 */
            font-weight: bold;
        }
        #statusMessage.success {
            color: green; /* 成功訊息顯示綠色 */
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="spinner" id="loadingSpinner"></div>
    <p id="initialMessage">正在處理您的請求，請稍候...</p>
    <div id="statusMessage"></div> <!-- 用於顯示最終結果訊息 -->

    <script>
        // 設定您的 Google Apps Script 網路應用程式的 URL
        // 請務必替換為您從 Apps Script 部署後複製的正確 '/exec' 網址
        const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzIw7zpB1zHkXyeuoCqJXwZgdouw6KkzYDxjNFLudH-8qH13CSjqBnMpTjuDDaH50ccTA/exec'; 

        // 重要的共享密鑰：必須與 Google Apps Script 中的 SECRET_KEY 保持一致
        const SECRET_KEY = 'F.ZEGZhmZwEPY=UnW#KNAdV8RG$pudpy'; // <-- 請務必替換為您自己的強密鑰

        // 定義回應代碼到訊息的映射 (與 Apps Script 中的 MESSAGES 保持一致)
        const RESPONSE_MESSAGES = {
            // 成功類 (1xx)
            100: { type: 'success', message: '預約成功。' },
            101: { type: 'success', message: '今日通知觸發器已設定，請勿重複預約。' },
            102: { type: 'success', message: '通知已立即發送。' },
            103: { type: 'success', message: '今日通知已發送。' },
            104: { type: 'success', message: '已成功取消預約。' },

            // 錯誤類 (2xx - 用戶操作/時間相關)
            200: { type: 'error', message: '非系統服務時間 (服務時間為 11:00 至 22:00)。' },
            201: { type: 'error', message: '連結已過期，請點擊 Line 官方帳號最新訊息中的連結。' },
            202: { type: 'error', message: '無效的操作。' },
            203: { type: 'error', message: '取消失敗：已過通知發送時間，無法取消。' },
            204: { type: 'error', message: '取消失敗：目前沒有設定任何預約通知。' },
            205: { type: 'error', message: '驗證失敗，請重新嘗試。' }, // 驗證碼錯誤或過期

            // 系統錯誤類 (5xx)
            500: { type: 'error', message: '第三方平台問題，請稍後再試。' },
            501: { type: 'error', message: '發生系統錯誤，請稍後再試。' }
        };

        /**
         * 獲取 URL 參數的值。
         * @param {string} name 參數名稱。
         * @returns {string|null} 參數值，如果不存在則為 null。
         */
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        /**
         * 純 JavaScript SHA-256 雜湊函數實現 (不依賴 crypto.subtle)。
         * 來源: https://geraintluff.github.io/sha256/ (輕微修改以符合您的輸出需求)
         * @param {string} msg 要 Hash 的字串。
         * @returns {string} SHA-256 Hash 值 (Base64 編碼)。
         */
        function sha256(msg) {
            function rotateRight(n, x) {
                return (x >>> n) | (x << (32 - n));
            }

            function processBlock(H, M) {
                const K = [
                    0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
                    0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
                    0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
                    0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
                    0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
                    0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
                    0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
                    0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
                ];
                let a = H[0], b = H[1], c = H[2], d = H[3], e = H[4], f = H[5], g = H[6], h = H[7];
                const W = new Array(64);

                for (let i = 0; i < 64; i++) {
                    if (i < 16) {
                        W[i] = M[i];
                    } else {
                        const s0 = rotateRight(7, W[i - 15]) ^ rotateRight(18, W[i - 15]) ^ (W[i - 15] >>> 3);
                        const s1 = rotateRight(17, W[i - 2]) ^ rotateRight(19, W[i - 2]) ^ (W[i - 2] >>> 10);
                        W[i] = (W[i - 16] + s0 + W[i - 7] + s1) | 0;
                    }

                    const S1 = rotateRight(6, e) ^ rotateRight(11, e) ^ rotateRight(25, e);
                    const ch = (e & f) ^ ((~e) & g);
                    const temp1 = (h + S1 + ch + K[i] + W[i]) | 0;
                    const S0 = rotateRight(2, a) ^ rotateRight(13, a) ^ rotateRight(22, a);
                    const maj = (a & b) ^ (a & c) ^ (b & c);
                    const temp2 = (S0 + maj) | 0;

                    h = g;
                    g = f;
                    f = e;
                    e = (d + temp1) | 0;
                    d = c;
                    c = b;
                    b = a;
                    a = (temp1 + temp2) | 0;
                }

                H[0] = (H[0] + a) | 0;
                H[1] = (H[1] + b) | 0;
                H[2] = (H[2] + c) | 0;
                H[3] = (H[3] + d) | 0;
                H[4] = (H[4] + e) | 0;
                H[5] = (H[5] + f) | 0;
                H[6] = (H[6] + g) | 0;
                H[7] = (H[7] + h) | 0;
            }

            const H = [
                0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a,
                0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19
            ];

            const utf8 = unescape(encodeURIComponent(msg));
            const L = utf8.length * 8; // length in bits
            
            const M = [];
            for (let i = 0; i < utf8.length; i++) {
                M[i >>> 2] |= (utf8.charCodeAt(i) & 0xFF) << (24 - (i % 4) * 8);
            }

            M[L >>> 5] |= 0x80 << (24 - (L % 32));
            M[(((L + 64) >>> 9) << 4) + 15] = L;

            for (let i = 0; i < M.length; i += 16) {
                processBlock(H, M.slice(i, i + 16));
            }
            
            // 將 Hash 輸出轉換為 Base64 字串
            let hashBytes = [];
            for(let i = 0; i < H.length; i++) {
                hashBytes.push((H[i] >>> 24) & 0xFF);
                hashBytes.push((H[i] >>> 16) & 0xFF);
                hashBytes.push((H[i] >>> 8) & 0xFF);
                hashBytes.push(H[i] & 0xFF);
            }
            return btoa(String.fromCharCode.apply(null, hashBytes));
        }

        /**
         * 獲取用戶 IP、當前日期和時間戳，並呼叫 Google Apps Script API。
         */
        async function processRequest() {
            const action = getUrlParameter('action');
            let userIp = '';

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const clickDate = `${year}-${month}-${day}`;

            const hours = String(today.getHours()).padStart(2, '0');
            const minutes = String(today.getMinutes()).padStart(2, '0');
            const timestampMinute = `${year}${month}${day}${hours}${minutes}`;

            let authToken = '';

            const loadingSpinner = document.getElementById('loadingSpinner');
            const initialMessage = document.getElementById('initialMessage');
            const statusMessageDiv = document.getElementById('statusMessage');

            try {
                // 使用純 JS 的 sha256 函數
                authToken = sha256(SECRET_KEY + action + timestampMinute); 
                
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                userIp = ipData.ip;
                console.log('獲取到的用戶 IP:', userIp);

                // 構建 Google Apps Script API 請求的 URL
                let apiUrl = `${GOOGLE_SCRIPT_WEB_APP_URL}?action=${encodeURIComponent(action)}`;
                apiUrl += `&userIp=${encodeURIComponent(userIp)}`;
                apiUrl += `&clickDate=${encodeURIComponent(clickDate)}`;
                apiUrl += `&ts=${encodeURIComponent(timestampMinute)}`;
                apiUrl += `&auth=${encodeURIComponent(authToken)}`;

                console.log('呼叫 Apps Script API:', apiUrl);

                const scriptResponse = await fetch(apiUrl);
                // 處理 Apps Script 返回的 JSON
                const result = await scriptResponse.json(); 

                // 根據返回的 code 顯示訊息
                const codeInfo = RESPONSE_MESSAGES[result.code];
                if (codeInfo) {
                    statusMessageDiv.innerText = codeInfo.message;
                    statusMessageDiv.className = codeInfo.type; // 添加 success 或 error class
                } else {
                    statusMessageDiv.innerText = '未知回應代碼: ' + result.code;
                    statusMessageDiv.className = 'error';
                }

            } catch (error) {
                console.error('處理請求或呼叫 API 失敗:', error);
                statusMessageDiv.innerText = '處理請求時發生錯誤，請稍後再試。';
                statusMessageDiv.className = 'error';
            } finally {
                // 不論成功或失敗，隱藏初始訊息和旋轉圖示
                loadingSpinner.style.display = 'none';
                initialMessage.style.display = 'none';
            }
        }

        // 頁面載入完成後立即執行
        document.addEventListener('DOMContentLoaded', processRequest);
    </script>
</body>
</html>
