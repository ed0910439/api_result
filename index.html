<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>處理中...</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 確保佔滿整個視窗高度 */
            width: 100vw; /* 確保佔滿整個視窗寬度 */
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        p {
            font-size: 1.1em;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <p>正在處理您的請求，請稍候...</p>

    <script>
        // 設定您的 Google Apps Script 網路應用程式的 URL
        const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzIw7zpB1zHkXyeuoCqJXwZgdouw6KkzYDxjNFLudH-8qH13CSjqBnMpTjuDDaH50ccTA/exec'; // <-- 請替換為您的實際 Google Apps Script 部署 URL

        // 重要的共享密鑰：必須與 Google Apps Script 中的 SECRET_KEY 保持一致
        const SECRET_KEY = 'F.ZEGZhmZwEPY=UnW#KNAdV8RG$pudpy'; // <-- 請務必替換為您自己的強密鑰

        /**
         * 獲取 URL 參數的值。
         * @param {string} name 參數名稱。
         * @returns {string|null} 參數值，如果不存在則為 null。
         */
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        /**
         * 產生 SHA-256 Hash。
         * @param {string} message 要 Hash 的字串。
         * @returns {Promise<string>} SHA-256 Hash 值 (Base64 編碼)。
         */
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            // 將 ArrayBuffer 轉換為 Base64 字串
            // 使用 btoa() 需要確保所有字節都在 0-255 範圍內
            // ArrayBuffer -> Uint8Array -> array of numbers -> String.fromCharCode -> btoa
            return btoa(String.fromCharCode.apply(null, new Uint8Array(hashBuffer)));
        }

        /**
         * 獲取用戶 IP、當前日期和時間戳，並重定向到 Google Apps Script。
         */
        async function processRequest() {
            const action = getUrlParameter('action'); // 從當前網頁 URL 獲取 action 參數
            let userIp = '';

            // 獲取當前日期 (YYYY-MM-DD 格式)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 月份從 0 開始
            const day = String(today.getDate()).padStart(2, '0');
            const clickDate = `${year}-${month}-${day}`; // 日期檢查參數

            // 獲取當前時間戳 (YYYYMMDDHHMM 格式，精確到分鐘)
            const hours = String(today.getHours()).padStart(2, '0');
            const minutes = String(today.getMinutes()).padStart(2, '0');
            const timestampMinute = `${year}${month}${day}${hours}${minutes}`; // 時間戳參數 (ts)

            let authToken = '';

            try {
                // 生成驗證碼
                authToken = await sha256(SECRET_KEY + action + timestampMinute);

                // 呼叫公共 IP 查詢服務
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIp = data.ip;
                console.log('獲取到的用戶 IP:', userIp);
            } catch (error) {
                console.error('處理請求失敗:', error);
                userIp = 'unknown'; // 如果獲取 IP 或生成驗證碼失敗，使用 'unknown'
                // 如果是驗證碼生成失敗，authToken 會是空字串，Apps Script 會將其視為驗證失敗
            }

            // 構建重定向到 Google Apps Script 的 URL
            let redirectUrl = `${GOOGLE_SCRIPT_WEB_APP_URL}?action=${encodeURIComponent(action)}`;
            redirectUrl += `&userIp=${encodeURIComponent(userIp)}`;
            redirectUrl += `&clickDate=${encodeURIComponent(clickDate)}`;
            redirectUrl += `&ts=${encodeURIComponent(timestampMinute)}`; // 新增時間戳
            redirectUrl += `&auth=${encodeURIComponent(authToken)}`;     // 新增驗證碼

            console.log('重定向到:', redirectUrl);
            window.location.href = redirectUrl; // 執行重定向
        }

        // 頁面載入完成後立即執行
        document.addEventListener('DOMContentLoaded', processRequest);
    </script>
</body>
</html>
